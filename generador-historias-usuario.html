<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Historias de Usuario</title>
    <meta name="description" content="Generador autom√°tico de historias de usuario con IA. Soporta OpenAI, Anthropic, Google Gemini y m√°s.">
    <meta name="keywords" content="historias de usuario, product owner, scrum, agile, IA, automatizaci√≥n">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body class="bg-gray-50">
    <div class="max-w-6xl mx-auto p-6 bg-white min-h-screen">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">
                Generador de Historias de Usuario con IA
            </h1>
            <p class="text-gray-600">
                Herramienta h√≠brida para generar historias de usuario siguiendo criterios INVEST
            </p>
        </div>

        <!-- Progress Steps -->
        <div class="mb-8">
            <div class="flex items-center space-x-4">
                <div class="flex items-center" id="step1">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center bg-blue-100 border-2 border-blue-600 text-blue-600">
                        <i data-lucide="file-text" class="w-4 h-4"></i>
                    </div>
                    <span class="ml-2 font-medium text-blue-600">1. Requerimiento</span>
                </div>
                <div class="flex-1 h-px bg-gray-300"></div>
                <div class="flex items-center text-gray-400" id="step2">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center bg-gray-100 border-2 border-gray-300">
                        <i data-lucide="alert-circle" class="w-4 h-4"></i>
                    </div>
                    <span class="ml-2 font-medium">2. An√°lisis</span>
                </div>
                <div class="flex-1 h-px bg-gray-300"></div>
                <div class="flex items-center text-gray-400" id="step3">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center bg-gray-100 border-2 border-gray-300">
                        <i data-lucide="check-circle" class="w-4 h-4"></i>
                    </div>
                    <span class="ml-2 font-medium">3. Historias</span>
                </div>
            </div>
        </div>

        <!-- Configuraci√≥n de IA -->
        <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <h3 class="text-lg font-semibold text-blue-800 mb-3">Configuraci√≥n de IA</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Servicio de IA</label>
                    <select id="aiService" class="w-full p-2 border border-gray-300 rounded-lg" onchange="updateModelOptions()">
                        <option value="openai">OpenAI (GPT-4)</option>
                        <option value="anthropic">Anthropic (Claude)</option>
                        <option value="google">Google (Gemini)</option>
                        <option value="openrouter">OpenRouter (M√∫ltiples modelos)</option>
                        <option value="custom">Personalizado</option>
                    </select>
                </div>
                <div id="modelSelection" style="display: none;">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Modelo</label>
                    <select id="aiModel" class="w-full p-2 border border-gray-300 rounded-lg">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <div id="customFields" style="display: none;" class="col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Endpoint URL</label>
                        <input type="text" id="customEndpoint" placeholder="https://api.example.com/v1/chat/completions" 
                               class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Modelo</label>
                        <input type="text" id="customModel" placeholder="gpt-4o-mini, claude-3-haiku, etc." 
                               class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                    <input type="password" id="apiKey" placeholder="Ingresa tu API key aqu√≠" 
                           class="w-full p-2 border border-gray-300 rounded-lg">
                </div>
            </div>
            <div class="mt-3">
                <button onclick="testConnection()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                    Probar Conexi√≥n
                </button>
                <span id="connectionStatus" class="ml-2 text-sm"></span>
            </div>
        </div>

        <!-- Step 1: Input -->
        <div id="inputStep" class="space-y-6">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h3 class="font-semibold text-blue-800 mb-2">Contexto del Proyecto</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Metodolog√≠a</label>
                        <select id="methodology" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="Scrum">Scrum</option>
                            <option value="Kanban">Kanban</option>
                            <option value="H√≠brido">H√≠brido</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Duraci√≥n Sprint</label>
                        <select id="sprintDuration" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="1 semana">1 semana</option>
                            <option value="2 semanas">2 semanas</option>
                            <option value="2-3 semanas" selected>2-3 semanas</option>
                            <option value="3 semanas">3 semanas</option>
                            <option value="4 semanas">4 semanas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tecnolog√≠a Principal (Opcional)</label>
                        <input type="text" id="technology" placeholder="React, Angular, .NET, etc." 
                               class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Describe el requerimiento</label>
                <textarea id="requirement" placeholder="Ejemplo: Agregar campo tipos de secci√≥n en espa√±ol para permitir a los usuarios seleccionar categor√≠as en su idioma nativo..." 
                          rows="6" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
            </div>

            <button onclick="generateQuestions()" id="generateQuestionsBtn" 
                    class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center space-x-2">
                <i data-lucide="send" class="w-4 h-4"></i>
                <span>Generar Preguntas de An√°lisis</span>
            </button>
        </div>

        <!-- Step 2: Questions -->
        <div id="questionsStep" class="space-y-6" style="display: none;">
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <h3 class="font-semibold text-green-800 mb-2">Requerimiento Analizado</h3>
                <p class="text-green-700" id="analyzedRequirement"></p>
            </div>

            <div>
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    Preguntas de Clarificaci√≥n - Ronda <span id="analysisRound">1</span>
                </h3>
                <div id="questionsContainer" class="space-y-4"></div>
                
                <div id="moreQuestionsBtn" class="mt-6 flex justify-center" style="display: none;">
                    <button onclick="generateMoreQuestions()" 
                            class="bg-orange-600 text-white px-6 py-2 rounded-md hover:bg-orange-700 disabled:bg-gray-400 flex items-center space-x-2">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        <span>¬øNecesitas m√°s claridad? Generar m√°s preguntas</span>
                    </button>
                </div>
                
                <div id="noMoreQuestions" class="mt-6 bg-green-50 border border-green-200 rounded-lg p-4 text-center" style="display: none;">
                    <div class="flex items-center justify-center space-x-2 text-green-800">
                        <i data-lucide="check-circle" class="w-5 h-5"></i>
                        <span class="font-medium">An√°lisis completo</span>
                    </div>
                    <p class="text-green-700 mt-2">
                        La informaci√≥n proporcionada es suficientemente clara para generar historias de usuario de calidad. 
                        Puedes proceder a generar las historias.
                    </p>
                </div>
            </div>

            <div class="flex space-x-4">
                <button onclick="showStep('input')" class="flex-1 bg-gray-200 text-gray-800 py-3 px-4 rounded-md hover:bg-gray-300">
                    Volver a Requerimiento
                </button>
                <button onclick="generateStories()" id="generateStoriesBtn" 
                        class="flex-1 bg-green-600 text-white py-3 px-4 rounded-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center space-x-2">
                    <i data-lucide="check-circle" class="w-4 h-4"></i>
                    <span>Generar Historias de Usuario</span>
                </button>
            </div>

            <!-- Help Section for Analysis -->
            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                <h4 class="font-semibold text-orange-800 mb-2">üí° Funciones de An√°lisis</h4>
                <ul class="text-sm text-orange-700 space-y-1">
                    <li>‚Ä¢ <strong>M√°s Preguntas:</strong> Genera preguntas de seguimiento para clarificar ambig√ºedades</li>
                    <li>‚Ä¢ <strong>Rondas iterativas:</strong> Puedes hacer m√∫ltiples rondas de an√°lisis antes de generar historias</li>
                    <li>‚Ä¢ <strong>Respuestas opcionales:</strong> No es necesario responder todas las preguntas para continuar</li>
                </ul>
            </div>
        </div>

        <!-- Step 3: Stories -->
        <div id="storiesStep" class="space-y-6" style="display: none;">
            <div id="reasoningContainer" class="bg-blue-50 border border-blue-200 rounded-lg p-4" style="display: none;">
                <h4 class="font-semibold text-blue-800 mb-2">üìä An√°lisis de Descomposici√≥n</h4>
                <p class="text-blue-700" id="storiesReasoning"></p>
            </div>
            
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-800">
                    Historias de Usuario Generadas (<span id="storiesCount">0</span>)
                </h3>
                <div class="flex space-x-2">
                    <button onclick="addNewStory()" id="addStoryBtn" 
                            class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 disabled:bg-gray-400 flex items-center space-x-2"
                            title="Generar una historia adicional basada en el contexto actual">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        <span>Nueva Historia</span>
                    </button>
                    <button onclick="exportAllStories()" 
                            class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center space-x-2"
                            title="Descargar todas las historias en formato de texto">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        <span>Exportar Todo</span>
                    </button>
                    <button onclick="resetGenerator()" 
                            class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 flex items-center space-x-2"
                            title="Reiniciar completamente - nuevo requerimiento desde cero">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        <span>Nuevo Requerimiento</span>
                    </button>
                </div>
            </div>

            <div id="storiesContainer" class="space-y-6"></div>

            <!-- Help Section for Refinement -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h4 class="font-semibold text-blue-800 mb-2">üîß Funciones de Refinamiento</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-blue-700">
                    <div>
                        <p><strong>Editar Historias:</strong></p>
                        <ul class="ml-4 space-y-1">
                            <li>‚Ä¢ Haz clic en el √≠cono de l√°piz para editar</li>
                            <li>‚Ä¢ Modifica t√≠tulo, roles, prioridad, story points</li>
                            <li>‚Ä¢ Edita criterios de aceptaci√≥n individualmente</li>
                            <li>‚Ä¢ Agrega/elimina criterios con los botones + y -</li>
                        </ul>
                    </div>
                    <div>
                        <p><strong>Gestionar Historias:</strong></p>
                        <ul class="ml-4 space-y-1">
                            <li>‚Ä¢ <strong>Nueva Historia:</strong> Genera historia adicional</li>
                            <li>‚Ä¢ <strong>Regenerar:</strong> Mejora una historia espec√≠fica</li>
                            <li>‚Ä¢ <strong>Eliminar:</strong> Quita historias innecesarias</li>
                            <li>‚Ä¢ <strong>Copiar:</strong> Copia formato listo para JIRA</li>
                        </ul>
                    </div>
                </div>
                <div class="mt-3 p-3 bg-blue-100 rounded">
                    <p class="text-blue-800 font-medium">üí° N√∫mero de Historias Inteligente</p>
                    <p class="text-blue-700 text-sm">El sistema analiza autom√°ticamente la complejidad del requerimiento para determinar el n√∫mero √≥ptimo de historias (1-8), siguiendo los principios de que cada historia debe ser completable en un sprint y aportar valor independiente.</p>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" style="display: none;" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mt-6">
            <div class="flex items-center space-x-2">
                <i data-lucide="loader-2" class="w-4 h-4 animate-spin text-yellow-800"></i>
                <p class="text-yellow-800" id="loadingText">Procesando...</p>
            </div>
        </div>

        <!-- INVEST Criteria Reference -->
        <div class="mt-8 bg-gray-50 border border-gray-200 rounded-lg p-6">
            <h3 class="font-semibold text-gray-800 mb-4">Criterios INVEST</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div>
                    <h4 class="font-medium text-gray-700">Independent</h4>
                    <p class="text-sm text-gray-600">Sin dependencias cr√≠ticas</p>
                </div>
                <div>
                    <h4 class="font-medium text-gray-700">Negotiable</h4>
                    <p class="text-sm text-gray-600">Detalles flexibles</p>
                </div>
                <div>
                    <h4 class="font-medium text-gray-700">Valuable</h4>
                    <p class="text-sm text-gray-600">Valor claro para el usuario</p>
                </div>
                <div>
                    <h4 class="font-medium text-gray-700">Estimable</h4>
                    <p class="text-sm text-gray-600">Complejidad clara (1-8 puntos)</p>
                </div>
                <div>
                    <h4 class="font-medium text-gray-700">Small</h4>
                    <p class="text-sm text-gray-600">Completable en 1 sprint</p>
                </div>
                <div>
                    <h4 class="font-medium text-gray-700">Testable</h4>
                    <p class="text-sm text-gray-600">Criterios verificables</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let questions = [];
        let answers = {};
        let stories = [];
        let currentStep = 'input';
        let editingStory = null;
        let analysisRound = 1;
        let noMoreQuestions = false;
        let storiesReasoning = '';

        // Inicializar iconos de Lucide
        lucide.createIcons();

        // Configuraci√≥n de modelos por servicio
        const modelConfigs = {
            openai: [
                { value: 'gpt-4o-mini', label: 'GPT-4o Mini (M√°s barato)', cost: 'Bajo' },
                { value: 'gpt-4o', label: 'GPT-4o (Recomendado)', cost: 'Medio' },
                { value: 'gpt-4', label: 'GPT-4 (Premium)', cost: 'Alto' }
            ],
            anthropic: [
                { value: 'claude-3-haiku-20240307', label: 'Claude 3 Haiku (M√°s barato)', cost: 'Bajo' },
                { value: 'claude-3-sonnet-20240229', label: 'Claude 3 Sonnet (Recomendado)', cost: 'Medio' },
                { value: 'claude-3-opus-20240229', label: 'Claude 3 Opus (Premium)', cost: 'Alto' }
            ],
            google: [
                { value: 'gemini-1.5-flash', label: 'Gemini 1.5 Flash (M√°s barato)', cost: 'Bajo' },
                { value: 'gemini-1.5-pro', label: 'Gemini 1.5 Pro (Recomendado)', cost: 'Medio' },
                { value: 'gemini-pro', label: 'Gemini Pro (Est√°ndar)', cost: 'Medio' }
            ],
            openrouter: [
                { value: 'openai/gpt-4o-mini', label: 'GPT-4o Mini (M√°s barato)', cost: 'Bajo' },
                { value: 'google/gemini-flash-1.5', label: 'Gemini 1.5 Flash (Barato)', cost: 'Bajo' },
                { value: 'anthropic/claude-3-haiku', label: 'Claude 3 Haiku (Barato)', cost: 'Bajo' },
                { value: 'meta-llama/llama-3.1-8b-instruct:free', label: 'Llama 3.1 8B (Gratis)', cost: 'Gratis' },
                { value: 'anthropic/claude-3-sonnet', label: 'Claude 3 Sonnet (Medio)', cost: 'Medio' },
                { value: 'openai/gpt-4o', label: 'GPT-4o (Medio)', cost: 'Medio' },
                { value: 'google/gemini-pro-1.5', label: 'Gemini 1.5 Pro (Medio)', cost: 'Medio' }
            ]
        };

        function updateModelOptions() {
            const service = document.getElementById('aiService').value;
            const modelSelect = document.getElementById('aiModel');
            const modelSelection = document.getElementById('modelSelection');
            const customFields = document.getElementById('customFields');

            modelSelection.style.display = 'none';
            customFields.style.display = 'none';

            if (service === 'openrouter' || service === 'google') {
                modelSelection.style.display = 'block';
                modelSelect.innerHTML = '';
                
                modelConfigs[service].forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.value;
                    option.textContent = `${model.label} - Costo: ${model.cost}`;
                    modelSelect.appendChild(option);
                });
            } else if (service === 'custom') {
                customFields.style.display = 'block';
            }
        }

        async function testConnection() {
            const service = document.getElementById('aiService').value;
            const apiKey = document.getElementById('apiKey').value;
            const statusElement = document.getElementById('connectionStatus');

            if (!apiKey) {
                statusElement.innerHTML = '<span class="text-red-600">‚ùå API Key requerida</span>';
                return;
            }

            statusElement.innerHTML = '<span class="text-blue-600">üîÑ Probando conexi√≥n...</span>';

            try {
                const response = await callAI('Responde solo "OK"', service, apiKey);
                if (response) {
                    statusElement.innerHTML = '<span class="text-green-600">‚úÖ Conexi√≥n exitosa</span>';
                } else {
                    statusElement.innerHTML = '<span class="text-red-600">‚ùå Conexi√≥n fallida</span>';
                }
            } catch (error) {
                statusElement.innerHTML = '<span class="text-red-600">‚ùå Error: ' + error.message + '</span>';
            }
        }

        async function callAI(prompt, service, apiKey) {
            let endpoints = {
                openai: 'https://api.openai.com/v1/chat/completions',
                anthropic: 'https://api.anthropic.com/v1/messages',
                google: 'https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent',
                openrouter: 'https://openrouter.ai/api/v1/chat/completions'
            };

            if (service === 'custom') {
                const customEndpoint = document.getElementById('customEndpoint').value;
                if (!customEndpoint) {
                    throw new Error('Endpoint URL requerido para configuraci√≥n personalizada');
                }
                endpoints.custom = customEndpoint;
            }

            const headers = { 'Content-Type': 'application/json' };
            let body;
            let selectedModel;
            let endpoint;
            
            switch (service) {
                case 'openai':
                    selectedModel = modelConfigs.openai[0].value;
                    headers['Authorization'] = `Bearer ${apiKey}`;
                    endpoint = endpoints.openai;
                    body = {
                        model: selectedModel,
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 2000
                    };
                    break;

                case 'anthropic':
                    selectedModel = modelConfigs.anthropic[0].value;
                    headers['x-api-key'] = apiKey;
                    headers['anthropic-version'] = '2023-06-01';
                    endpoint = endpoints.anthropic;
                    body = {
                        model: selectedModel,
                        max_tokens: 2000,
                        messages: [{ role: 'user', content: prompt }]
                    };
                    break;

                case 'google':
                    selectedModel = document.getElementById('aiModel').value || modelConfigs.google[0].value;
                    headers['x-goog-api-key'] = apiKey;
                    endpoint = endpoints.google.replace('{model}', selectedModel);
                    body = {
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { maxOutputTokens: 2000 }
                    };
                    break;

                case 'openrouter':
                    selectedModel = document.getElementById('aiModel').value || modelConfigs.openrouter[0].value;
                    headers['Authorization'] = `Bearer ${apiKey}`;
                    headers['HTTP-Referer'] = window.location.href;
                    headers['X-Title'] = 'Generador de Historias de Usuario';
                    endpoint = endpoints.openrouter;
                    body = {
                        model: selectedModel,
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 2000
                    };
                    break;

                case 'custom':
                    selectedModel = document.getElementById('customModel').value;
                    if (!selectedModel) {
                        throw new Error('Modelo requerido para configuraci√≥n personalizada');
                    }
                    headers['Authorization'] = `Bearer ${apiKey}`;
                    endpoint = endpoints.custom;
                    body = {
                        model: selectedModel,
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 2000
                    };
                    break;
            }

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(body)
            });

            if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();

            switch (service) {
                case 'openai':
                case 'openrouter':
                case 'custom':
                    return data.choices[0].message.content;
                case 'anthropic':
                    return data.content[0].text;
                case 'google':
                    return data.candidates[0].content.parts[0].text;
            }
        }

        function showStep(step) {
            document.getElementById('inputStep').style.display = 'none';
            document.getElementById('questionsStep').style.display = 'none';
            document.getElementById('storiesStep').style.display = 'none';
            
            document.getElementById('step1').className = 'flex items-center text-gray-400';
            document.getElementById('step2').className = 'flex items-center text-gray-400';
            document.getElementById('step3').className = 'flex items-center text-gray-400';

            document.getElementById(`${step}Step`).style.display = 'block';
            
            if (step === 'input') {
                document.getElementById('step1').className = 'flex items-center text-blue-600';
                document.getElementById('step1').querySelector('.w-8').className = 'w-8 h-8 rounded-full flex items-center justify-center bg-blue-100 border-2 border-blue-600';
            } else if (step === 'questions') {
                document.getElementById('step1').className = 'flex items-center text-green-600';
                document.getElementById('step1').querySelector('.w-8').className = 'w-8 h-8 rounded-full flex items-center justify-center bg-green-100 border-2 border-green-600';
                document.getElementById('step2').className = 'flex items-center text-blue-600';
                document.getElementById('step2').querySelector('.w-8').className = 'w-8 h-8 rounded-full flex items-center justify-center bg-blue-100 border-2 border-blue-600';
            } else if (step === 'stories') {
                document.getElementById('step1').className = 'flex items-center text-green-600';
                document.getElementById('step1').querySelector('.w-8').className = 'w-8 h-8 rounded-full flex items-center justify-center bg-green-100 border-2 border-green-600';
                document.getElementById('step2').className = 'flex items-center text-green-600';
                document.getElementById('step2').querySelector('.w-8').className = 'w-8 h-8 rounded-full flex items-center justify-center bg-green-100 border-2 border-green-600';
                document.getElementById('step3').className = 'flex items-center text-blue-600';
                document.getElementById('step3').querySelector('.w-8').className = 'w-8 h-8 rounded-full flex items-center justify-center bg-blue-100 border-2 border-blue-600';
            }
            
            currentStep = step;
            lucide.createIcons();
        }

        async function generateQuestions() {
            const requirement = document.getElementById('requirement').value;
            const methodology = document.getElementById('methodology').value;
            const sprintDuration = document.getElementById('sprintDuration').value;
            const technology = document.getElementById('technology').value;
            const service = document.getElementById('aiService').value;
            const apiKey = document.getElementById('apiKey').value;

            if (!requirement.trim()) {
                alert('Por favor, describe el requerimiento');
                return;
            }

            if (!apiKey) {
                alert('Por favor, configura tu API Key');
                return;
            }

            document.getElementById('generateQuestionsBtn').disabled = true;
            document.getElementById('generateQuestionsBtn').innerHTML = `
                <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                <span>Analizando requerimiento...</span>
            `;
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('loadingText').textContent = 'Analizando requerimiento...';

            const prompt = `Act√∫a como Product Owner experto. Analiza el siguiente requerimiento y genera 3-5 preguntas espec√≠ficas para clarificar:

Requerimiento: "${requirement}"

Contexto del proyecto:
- Metodolog√≠a: ${methodology}
- Sprint: ${sprintDuration}
- Tecnolog√≠a: ${technology || 'No especificada'}

IMPORTANTE: Tu respuesta debe ser √öNICAMENTE un objeto JSON v√°lido. NO uses bloques de c√≥digo markdown.

Formato requerido:
{
  "questions": [
    {
      "id": 1,
      "category": "Contexto del negocio",
      "question": "¬øCu√°l es el objetivo principal de esta funcionalidad?",
      "placeholder": "Ejemplo: Mejorar la experiencia del usuario al..."
    }
  ]
}`;

            try {
                const response = await callAI(prompt, service, apiKey);
                
                let cleanResponse = response.trim();
                if (cleanResponse.startsWith('```json')) {
                    cleanResponse = cleanResponse.replace(/```json\s*/, '').replace(/```\s*$/, '');
                } else if (cleanResponse.startsWith('```')) {
                    cleanResponse = cleanResponse.replace(/```\s*/, '').replace(/```\s*$/, '');
                }
                
                const data = JSON.parse(cleanResponse);
                questions = data.questions;
                document.getElementById('analyzedRequirement').textContent = requirement;
                renderQuestions();
                showStep('questions');
            } catch (error) {
                console.error('Error generating questions:', error);
                alert('Error al generar preguntas. Por favor, intenta de nuevo.');
            } finally {
                document.getElementById('generateQuestionsBtn').disabled = false;
                document.getElementById('generateQuestionsBtn').innerHTML = `
                    <i data-lucide="send" class="w-4 h-4"></i>
                    <span>Generar Preguntas de An√°lisis</span>
                `;
                document.getElementById('loadingIndicator').style.display = 'none';
                lucide.createIcons();
            }
        }

        function renderQuestions() {
            const container = document.getElementById('questionsContainer');
            
            // Primero, guardar los valores actuales de los textareas antes de recrear
            const currentAnswers = {};
            questions.forEach(question => {
                const textarea = document.getElementById(`answer_${question.id}`);
                if (textarea) {
                    currentAnswers[question.id] = textarea.value;
                    answers[question.id] = textarea.value; // Actualizar el objeto answers
                }
            });
            
            container.innerHTML = '';
            
            questions.forEach(question => {
                const div = document.createElement('div');
                div.className = 'border border-gray-200 rounded-lg p-4';
                div.innerHTML = `
                    <div class="mb-2">
                        <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">
                            ${question.category}
                        </span>
                    </div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ${question.question}
                    </label>
                    <textarea 
                        id="answer_${question.id}"
                        placeholder="${question.placeholder}"
                        rows="3"
                        class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        onchange="updateAnswer(${question.id}, this.value)"
                    >${currentAnswers[question.id] || answers[question.id] || ''}</textarea>
                `;
                container.appendChild(div);
            });

            // Mostrar bot√≥n de m√°s preguntas si hay respuestas y no se ha marcado como completo
            if (questions.length > 0 && !noMoreQuestions) {
                document.getElementById('moreQuestionsBtn').style.display = 'flex';
            } else {
                document.getElementById('moreQuestionsBtn').style.display = 'none';
            }
        }

        function updateAnswer(questionId, value) {
            answers[questionId] = value;
        }

        async function generateMoreQuestions() {
            const service = document.getElementById('aiService').value;
            const apiKey = document.getElementById('apiKey').value;
            const requirement = document.getElementById('requirement').value;

            if (!apiKey) {
                alert('Por favor, configura tu API Key');
                return;
            }

            const answersText = Object.entries(answers)
                .map(([id, answer]) => {
                    const question = questions.find(q => q.id.toString() === id);
                    return `${question?.question}: ${answer}`;
                })
                .join('\n');

            // Deshabilitar el bot√≥n y mostrar loading
            const moreQuestionsBtn = document.querySelector('#moreQuestionsBtn button');
            moreQuestionsBtn.disabled = true;
            moreQuestionsBtn.innerHTML = `
                <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                <span>Analizando respuestas...</span>
            `;
            
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('loadingText').textContent = 'Generando m√°s preguntas...';

            const prompt = `Act√∫a como Product Owner experto. Genera 2-4 preguntas de seguimiento bas√°ndote en:

REQUERIMIENTO: "${requirement}"
RESPUESTAS ANTERIORES: ${answersText}

IMPORTANTE: Tu respuesta debe ser √öNICAMENTE un objeto JSON v√°lido.

Formato requerido:
{
  "questions": [
    {
      "id": ${questions.length + 1},
      "category": "Categor√≠a",
      "question": "Pregunta de seguimiento",
      "placeholder": "Ejemplo de respuesta"
    }
  ]
}`;

            try {
                const response = await callAI(prompt, service, apiKey);
                
                let cleanResponse = response.trim();
                if (cleanResponse.startsWith('```json')) {
                    cleanResponse = cleanResponse.replace(/```json\s*/, '').replace(/```\s*$/, '');
                } else if (cleanResponse.startsWith('```')) {
                    cleanResponse = cleanResponse.replace(/```\s*/, '').replace(/```\s*$/, '');
                }
                
                const data = JSON.parse(cleanResponse);
                
                if (data.questions && data.questions.length === 0) {
                    noMoreQuestions = true;
                    document.getElementById('moreQuestionsBtn').style.display = 'none';
                    document.getElementById('noMoreQuestions').style.display = 'block';
                } else if (data.message && data.message.includes('suficientemente claro')) {
                    noMoreQuestions = true;
                    document.getElementById('moreQuestionsBtn').style.display = 'none';
                    document.getElementById('noMoreQuestions').style.display = 'block';
                } else {
                    questions = [...questions, ...data.questions];
                    analysisRound++;
                    document.getElementById('analysisRound').textContent = analysisRound;
                    renderQuestions();
                }
            } catch (error) {
                console.error('Error generating follow-up questions:', error);
                alert('Error al generar preguntas de seguimiento. Por favor, intenta de nuevo.');
            } finally {
                // Restaurar el bot√≥n
                moreQuestionsBtn.disabled = false;
                moreQuestionsBtn.innerHTML = `
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    <span>¬øNecesitas m√°s claridad? Generar m√°s preguntas</span>
                `;
                document.getElementById('loadingIndicator').style.display = 'none';
                lucide.createIcons();
            }
        }

        async function generateStories() {
            const service = document.getElementById('aiService').value;
            const apiKey = document.getElementById('apiKey').value;
            const requirement = document.getElementById('requirement').value;

            if (Object.keys(answers).length === 0) {
                alert('Por favor, responde al menos una pregunta antes de generar historias');
                return;
            }

            const answersText = Object.entries(answers)
                .map(([id, answer]) => {
                    const question = questions.find(q => q.id.toString() === id);
                    return `${question?.question}: ${answer}`;
                })
                .join('\n');

            document.getElementById('generateStoriesBtn').disabled = true;
            document.getElementById('generateStoriesBtn').innerHTML = `
                <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                <span>Generando historias...</span>
            `;
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('loadingText').textContent = 'Generando historias de usuario...';

            const prompt = `Act√∫a como Product Owner experto. Analiza el requerimiento y determina el n√∫mero √≥ptimo de historias de usuario necesarias.

REQUERIMIENTO: "${requirement}"
CONTEXTO: ${answersText}

INSTRUCCIONES:
1. Eval√∫a la complejidad y alcance del requerimiento
2. Descomp√≥n en historias independientes que sigan criterios INVEST
3. Genera entre 1-8 historias seg√∫n sea necesario:
   - Requerimientos simples: 1-2 historias
   - Requerimientos medianos: 2-4 historias
   - Requerimientos complejos: 4-8 historias
4. Cada historia debe ser completable en 1 sprint
5. Prioriza por valor de negocio y dependencias t√©cnicas

IMPORTANTE: Tu respuesta debe ser √öNICAMENTE un objeto JSON v√°lido.

Formato requerido:
{
  "totalStories": "N√∫mero de historias generadas",
  "reasoning": "Breve explicaci√≥n del n√∫mero de historias elegido",
  "stories": [
    {
      "id": 1,
      "title": "T√≠tulo descriptivo",
      "role": "Usuario espec√≠fico",
      "functionality": "Funcionalidad concreta",
      "benefit": "Beneficio/objetivo",
      "acceptanceCriteria": ["criterio1", "criterio2"],
      "definitionOfDone": ["item1", "item2"],
      "dependencies": "Ninguna",
      "technicalNotes": "Notas t√©cnicas",
      "storyPoints": 3,
      "priority": "Alta/Media/Baja",
      "type": "Historia de Usuario"
    }
  ]
}`;

            try {
                const response = await callAI(prompt, service, apiKey);
                
                let cleanResponse = response.trim();
                if (cleanResponse.startsWith('```json')) {
                    cleanResponse = cleanResponse.replace(/```json\s*/, '').replace(/```\s*$/, '');
                } else if (cleanResponse.startsWith('```')) {
                    cleanResponse = cleanResponse.replace(/```\s*/, '').replace(/```\s*$/, '');
                }
                
                const data = JSON.parse(cleanResponse);
                stories = data.stories;
                storiesReasoning = data.reasoning || '';
                
                if (storiesReasoning) {
                    document.getElementById('storiesReasoning').textContent = storiesReasoning;
                    document.getElementById('reasoningContainer').style.display = 'block';
                }
                
                renderStories();
                showStep('stories');
            } catch (error) {
                console.error('Error generating stories:', error);
                alert('Error al generar historias. Por favor, intenta de nuevo.');
            } finally {
                document.getElementById('generateStoriesBtn').disabled = false;
                document.getElementById('generateStoriesBtn').innerHTML = `
                    <i data-lucide="check-circle" class="w-4 h-4"></i>
                    <span>Generar Historias de Usuario</span>
                `;
                document.getElementById('loadingIndicator').style.display = 'none';
                lucide.createIcons();
            }
        }

        function renderStories() {
            const container = document.getElementById('storiesContainer');
            container.innerHTML = '';
            
            document.getElementById('storiesCount').textContent = stories.length;
            
            stories.forEach(story => {
                const div = document.createElement('div');
                div.className = 'border border-gray-200 rounded-lg p-6 bg-white shadow-sm';
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800">
                                Historia ${story.id}: 
                                ${editingStory === story.id ? 
                                    `<input type="text" value="${story.title}" onchange="updateStory(${story.id}, 'title', this.value)" class="border border-gray-300 rounded px-2 py-1 ml-2">` : 
                                    story.title
                                }
                            </h4>
                            <div class="flex items-center space-x-4 mt-2">
                                <span class="inline-block px-2 py-1 rounded-full text-xs ${getPriorityClass(story.priority)}">
                                    ${editingStory === story.id ? 
                                        `<select onchange="updateStory(${story.id}, 'priority', this.value)" class="border-none bg-transparent">
                                            <option value="Alta" ${story.priority === 'Alta' ? 'selected' : ''}>Alta</option>
                                            <option value="Media" ${story.priority === 'Media' ? 'selected' : ''}>Media</option>
                                            <option value="Baja" ${story.priority === 'Baja' ? 'selected' : ''}>Baja</option>
                                        </select>` : 
                                        story.priority
                                    }
                                </span>
                                <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">
                                    ${editingStory === story.id ? 
                                        `<input type="number" min="1" max="13" value="${story.storyPoints}" onchange="updateStory(${story.id}, 'storyPoints', parseInt(this.value))" class="w-12 border-none bg-transparent text-center">` : 
                                        story.storyPoints
                                    } SP
                                </span>
                                <span class="inline-block bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded-full">
                                    ${story.type}
                                </span>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            ${editingStory === story.id ? 
                                `<button onclick="setEditingStory(null)" class="text-green-600 hover:text-green-800 p-2 rounded-md hover:bg-green-50" title="Guardar cambios">
                                    <i data-lucide="check-circle" class="w-4 h-4"></i>
                                </button>` :
                                `<button onclick="setEditingStory(${story.id})" class="text-gray-600 hover:text-gray-800 p-2 rounded-md hover:bg-gray-50" title="Editar historia">
                                    <i data-lucide="edit-3" class="w-4 h-4"></i>
                                </button>`
                            }
                            <button onclick="regenerateStory(${story.id})" class="text-blue-600 hover:text-blue-800 p-2 rounded-md hover:bg-blue-50" title="Regenerar historia con IA">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            </button>
                            <button onclick="copyStoryToClipboard(${story.id})" class="text-blue-600 hover:text-blue-800 p-2 rounded-md hover:bg-blue-50" title="Copiar historia">
                                <i data-lucide="copy" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deleteStory(${story.id})" class="text-red-600 hover:text-red-800 p-2 rounded-md hover:bg-red-50" title="Eliminar historia">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <p class="text-gray-800">
                            <strong>Como</strong> ${editingStory === story.id ? 
                                `<input type="text" value="${story.role}" onchange="updateStory(${story.id}, 'role', this.value)" class="border border-gray-300 rounded px-2 py-1 ml-2 w-full mt-1">` : 
                                story.role
                            }<br>
                            <strong>Quiero</strong> ${editingStory === story.id ? 
                                `<textarea onchange="updateStory(${story.id}, 'functionality', this.value)" class="border border-gray-300 rounded px-2 py-1 ml-2 w-full mt-1" rows="2">${story.functionality}</textarea>` : 
                                story.functionality
                            }<br>
                            <strong>Para</strong> ${editingStory === story.id ? 
                                `<textarea onchange="updateStory(${story.id}, 'benefit', this.value)" class="border border-gray-300 rounded px-2 py-1 ml-2 w-full mt-1" rows="2">${story.benefit}</textarea>` : 
                                story.benefit
                            }
                        </p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <h5 class="font-medium text-gray-700">Criterios de Aceptaci√≥n</h5>
                                ${editingStory === story.id ? 
                                    `<button onclick="addAcceptanceCriteria(${story.id})" class="text-green-600 hover:text-green-800 p-1 rounded" title="Agregar criterio">
                                        <i data-lucide="plus" class="w-3 h-3"></i>
                                    </button>` : ''
                                }
                            </div>
                            <ul class="space-y-1">
                                ${story.acceptanceCriteria.map((criteria, index) => `
                                    <li class="flex items-start space-x-2">
                                        <span class="text-blue-600 mt-1">‚Ä¢</span>
                                        ${editingStory === story.id ? 
                                            `<div class="flex-1 flex items-center space-x-2">
                                                <textarea onchange="updateAcceptanceCriteria(${story.id}, ${index}, this.value)" class="flex-1 text-sm border border-gray-300 rounded px-2 py-1" rows="2">${criteria}</textarea>
                                                <button onclick="removeAcceptanceCriteria(${story.id}, ${index})" class="text-red-600 hover:text-red-800" title="Eliminar criterio">
                                                    <i data-lucide="trash-2" class="w-3 h-3"></i>
                                                </button>
                                            </div>` : 
                                            `<span class="text-sm text-gray-600">${criteria}</span>`
                                        }
                                    </li>
                                `).join('')}
                            </ul>
                        </div>

                        <div>
                            <h5 class="font-medium text-gray-700 mb-2">Definici√≥n de Terminado</h5>
                            <ul class="space-y-1">
                                ${story.definitionOfDone.map(item => `
                                    <li class="flex items-start space-x-2">
                                        <span class="text-green-600 mt-1">‚úì</span>
                                        <span class="text-sm text-gray-600">${item}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h5 class="font-medium text-gray-700 mb-1">Dependencias</h5>
                                ${editingStory === story.id ? 
                                    `<input type="text" value="${story.dependencies}" onchange="updateStory(${story.id}, 'dependencies', this.value)" class="text-sm text-gray-600 border border-gray-300 rounded px-2 py-1 w-full">` : 
                                    `<p class="text-sm text-gray-600">${story.dependencies}</p>`
                                }
                            </div>
                            <div>
                                <h5 class="font-medium text-gray-700 mb-1">Notas T√©cnicas</h5>
                                ${editingStory === story.id ? 
                                    `<textarea onchange="updateStory(${story.id}, 'technicalNotes', this.value)" class="text-sm text-gray-600 border border-gray-300 rounded px-2 py-1 w-full" rows="3">${story.technicalNotes}</textarea>` : 
                                    `<p class="text-sm text-gray-600">${story.technicalNotes}</p>`
                                }
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
            
            lucide.createIcons();
        }

        function getPriorityClass(priority) {
            switch(priority) {
                case 'Alta': return 'bg-red-100 text-red-800';
                case 'Media': return 'bg-yellow-100 text-yellow-800';
                case 'Baja': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function setEditingStory(storyId) {
            editingStory = storyId;
            renderStories();
        }

        function updateStory(storyId, field, value) {
            const storyIndex = stories.findIndex(s => s.id === storyId);
            if (storyIndex !== -1) {
                stories[storyIndex][field] = value;
            }
        }

        function updateAcceptanceCriteria(storyId, index, value) {
            const storyIndex = stories.findIndex(s => s.id === storyId);
            if (storyIndex !== -1) {
                stories[storyIndex].acceptanceCriteria[index] = value;
            }
        }

        function addAcceptanceCriteria(storyId) {
            const storyIndex = stories.findIndex(s => s.id === storyId);
            if (storyIndex !== -1) {
                stories[storyIndex].acceptanceCriteria.push('Nuevo criterio');
                renderStories();
            }
        }

        function removeAcceptanceCriteria(storyId, index) {
            const storyIndex = stories.findIndex(s => s.id === storyId);
            if (storyIndex !== -1) {
                stories[storyIndex].acceptanceCriteria.splice(index, 1);
                renderStories();
            }
        }

        function deleteStory(storyId) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar esta historia?')) {
                stories = stories.filter(s => s.id !== storyId);
                renderStories();
            }
        }

        async function regenerateStory(storyId) {
            const service = document.getElementById('aiService').value;
            const apiKey = document.getElementById('apiKey').value;
            const currentStory = stories.find(s => s.id === storyId);
            
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('loadingText').textContent = 'Regenerando historia...';

            const answersText = Object.entries(answers)
                .map(([id, answer]) => {
                    const question = questions.find(q => q.id.toString() === id);
                    return `${question?.question}: ${answer}`;
                })
                .join('\n');

            const prompt = `Mejora esta historia de usuario bas√°ndote en las modificaciones realizadas:

CONTEXTO: ${answersText}
HISTORIA ACTUAL MODIFICADA:
- T√≠tulo: ${currentStory.title}
- Rol: ${currentStory.role}  
- Funcionalidad: ${currentStory.functionality}
- Beneficio: ${currentStory.benefit}
- Criterios actuales: ${currentStory.acceptanceCriteria.join(', ')}
- Prioridad: ${currentStory.priority}
- Story Points: ${currentStory.storyPoints}

INSTRUCCIONES: Regenera y mejora esta historia tomando en cuenta todas las modificaciones realizadas por el usuario. Mant√©n la esencia de los cambios pero mejora la redacci√≥n, criterios de aceptaci√≥n y completitud.

Formato JSON requerido:
{
  "story": {
    "id": ${storyId},
    "title": "T√≠tulo mejorado",
    "role": "Usuario",
    "functionality": "Funcionalidad",
    "benefit": "Beneficio",
    "acceptanceCriteria": ["criterio1"],
    "definitionOfDone": ["item1"],
    "dependencies": "Ninguna",
    "technicalNotes": "Notas",
    "storyPoints": 3,
    "priority": "Media",
    "type": "Historia de Usuario"
  }
}`;

            try {
                const response = await callAI(prompt, service, apiKey);
                
                let cleanResponse = response.trim();
                if (cleanResponse.startsWith('```json')) {
                    cleanResponse = cleanResponse.replace(/```json\s*/, '').replace(/```\s*$/, '');
                } else if (cleanResponse.startsWith('```')) {
                    cleanResponse = cleanResponse.replace(/```\s*/, '').replace(/```\s*$/, '');
                }
                
                const data = JSON.parse(cleanResponse);
                const storyIndex = stories.findIndex(s => s.id === storyId);
                if (storyIndex !== -1) {
                    stories[storyIndex] = data.story;
                    renderStories();
                }
            } catch (error) {
                console.error('Error regenerating story:', error);
                alert('Error al regenerar la historia. Por favor, intenta de nuevo.');
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        async function addNewStory() {
            const service = document.getElementById('aiService').value;
            const apiKey = document.getElementById('apiKey').value;
            const requirement = document.getElementById('requirement').value;
            
            document.getElementById('addStoryBtn').disabled = true;
            document.getElementById('addStoryBtn').innerHTML = `
                <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                <span>Generando...</span>
            `;
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('loadingText').textContent = 'Generando nueva historia...';

            const answersText = Object.entries(answers)
                .map(([id, answer]) => {
                    const question = questions.find(q => q.id.toString() === id);
                    return `${question?.question}: ${answer}`;
                })
                .join('\n');

            const prompt = `Genera UNA historia adicional para:

REQUERIMIENTO: "${requirement}"
CONTEXTO: ${answersText}
HISTORIAS EXISTENTES: ${stories.map(s => s.title).join(', ')}

Formato JSON:
{
  "story": {
    "id": ${stories.length + 1},
    "title": "Nueva historia",
    "role": "Usuario",
    "functionality": "Funcionalidad",
    "benefit": "Beneficio",
    "acceptanceCriteria": ["criterio1"],
    "definitionOfDone": ["item1"],
    "dependencies": "Ninguna",
    "technicalNotes": "Notas",
    "storyPoints": 3,
    "priority": "Media",
    "type": "Historia de Usuario"
  }
}`;

            try {
                const response = await callAI(prompt, service, apiKey);
                
                let cleanResponse = response.trim();
                if (cleanResponse.startsWith('```json')) {
                    cleanResponse = cleanResponse.replace(/```json\s*/, '').replace(/```\s*$/, '');
                } else if (cleanResponse.startsWith('```')) {
                    cleanResponse = cleanResponse.replace(/```\s*/, '').replace(/```\s*$/, '');
                }
                
                const data = JSON.parse(cleanResponse);
                stories.push(data.story);
                renderStories();
            } catch (error) {
                console.error('Error adding new story:', error);
                alert('Error al generar nueva historia. Por favor, intenta de nuevo.');
            } finally {
                document.getElementById('addStoryBtn').disabled = false;
                document.getElementById('addStoryBtn').innerHTML = `
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    <span>Nueva Historia</span>
                `;
                document.getElementById('loadingIndicator').style.display = 'none';
                lucide.createIcons();
            }
        }

        function copyStoryToClipboard(storyId) {
            const story = stories.find(s => s.id === storyId);
            const storyText = `**Historia ${story.id}:** ${story.title}
**Como** ${story.role}
**Quiero** ${story.functionality}
**Para** ${story.benefit}

**Criterios de aceptaci√≥n:**
${story.acceptanceCriteria.map(criteria => `- ${criteria}`).join('\n')}

**Definici√≥n de terminado:**
${story.definitionOfDone.map(item => `- [ ] ${item}`).join('\n')}

**Dependencias:** ${story.dependencies}
**Notas t√©cnicas:** ${story.technicalNotes}
**Story Points:** ${story.storyPoints}
**Prioridad:** ${story.priority}`;

            navigator.clipboard.writeText(storyText).then(() => {
                alert('Historia copiada al portapapeles');
            }).catch(() => {
                const textArea = document.createElement('textarea');
                textArea.value = storyText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Historia copiada al portapapeles');
            });
        }

        function exportAllStories() {
            const allStories = stories.map(story => `**Historia ${story.id}:** ${story.title}
**Como** ${story.role}
**Quiero** ${story.functionality}
**Para** ${story.benefit}

**Criterios de aceptaci√≥n:**
${story.acceptanceCriteria.map(criteria => `- ${criteria}`).join('\n')}

**Definici√≥n de terminado:**
${story.definitionOfDone.map(item => `- [ ] ${item}`).join('\n')}

**Dependencias:** ${story.dependencies}
**Notas t√©cnicas:** ${story.technicalNotes}
**Story Points:** ${story.storyPoints}
**Prioridad:** ${story.priority}`).join('\n\n---\n\n');

            const blob = new Blob([allStories], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'historias_usuario.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        function resetGenerator() {
            if (confirm('¬øEst√°s seguro de que quieres reiniciar? Se perder√°n todos los datos.')) {
                questions = [];
                answers = {};
                stories = [];
                editingStory = null;
                analysisRound = 1;
                storiesReasoning = '';
                noMoreQuestions = false;
                
                document.getElementById('requirement').value = '';
                document.getElementById('methodology').value = 'Scrum';
                document.getElementById('sprintDuration').value = '2-3 semanas';
                document.getElementById('technology').value = '';
                
                document.getElementById('reasoningContainer').style.display = 'none';
                document.getElementById('moreQuestionsBtn').style.display = 'none';
                document.getElementById('noMoreQuestions').style.display = 'none';
                
                showStep('input');
            }
        }
    </script>
</body>
</html>